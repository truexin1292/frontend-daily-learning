<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Promise</title>
</head>
<body>
<script>
    // class Promise1 {
    //     constructor() {
    //         this.callbacks = []
    //         this.oncatch = null
    //     }
    //
    //     reject(result) {
    //         this.complete('reject', result)
    //     }
    //
    //     resolve(result) {
    //         this.complete('resolve', result)
    //     }
    //
    //     complete(type, result) {
    //         if (type === 'reject' && this.oncatch) {
    //             this.callbacks = []
    //             this.oncatch(result)
    //         } else if (this.callbacks[0]) {// åˆ¤æ–­ç¬¬ä¸€ä¸ª
    //             var handlerObj = this.callbacks.shift() // å–å‡ºç¬¬ä¸€ä¸ªï¼Œä¿®æ”¹åŸæ•°ç»„ï¼›
    //             if (handlerObj[type]) {
    //                 handlerObj[type](result)
    //             }
    //         }
    //     }
    //
    //     then(onsuccess, onfail) {
    //         this.callbacks.push({
    //             resolve: onsuccess,
    //             reject: onfail
    //         })
    //         return this
    //     }
    //
    //     catch(onfail) {
    //         this.oncatch = onfail
    //         return this
    //     }
    // }
    //
    // var promise = new Promise1()
    //
    // function fn1() {
    //     setTimeout(function () {
    //         var random = Math.random();
    //         console.log('--log--:', random)
    //         if (random > 0.5) {
    //             promise.resolve('æ­å·')
    //         } else {
    //             promise.reject('æ­å·')
    //         }
    //     })
    //     return promise
    // }
    //
    // function success1(city) {
    //     setTimeout(function () {
    //         promise.resolve(city + 'æ™´å¤©')
    //         console.log(city + 'æ™´å¤©')
    //     }, 1000)
    // }
    //
    // function error1(city) {
    //     setTimeout(function () {
    //         promise.reject(city + 'ä¸‹é›¨ğŸŒ§å¤©')
    //         console.log(city + 'ä¸‹é›¨ğŸŒ§å¤©')
    //     }, 1000)
    // }
    //
    // function success2(weather) {
    //     setTimeout(function () {
    //         console.log(weather + 'ï¼Œå¤©æ°”ä¸é”™ï¼Œå¯æºå¥³å‹ä¸ç‹—å‡ºè¡Œ')
    //     }, 1000)
    // }
    //
    // function error2(weather) {
    //     setTimeout(function () {
    //         console.log(weather + 'ï¼Œæ— æ³•å¸¦ç‹—ç‹—ç©äº†ï¼')
    //     }, 1000)
    // }
    //
    // function onerror() {
    //     console.log('é”™è¯¯âå•¦')
    // }
    //
    // fn1().then(success1, error1)
    //     .then(success2, error2)
    //     .catch(onerror)

    /*Promise çš„ç®€å•å®ç°*/
    class MyPromise {
        constructor(fn) {
            this.resolvedCallbacks = [];
            this.rejectedCallbacks = [];
            this.state = "PADDING";
            this.value = "";
            fn(this.resolve.bind(this), this.reject.bind(this));
        }

        resolve(value) {
            if (this.state === "PADDING") {
                this.state = "RESOLVED";
                // setTimeout(() => {
                this.value = value;
                this.resolvedCallbacks.forEach(cb => cb());
                // })
                // return this;
            }
        }

        reject(value) {
            if (this.state === "PADDING") {
                this.state = "REJECTED";
                // setTimeout(() => {
                this.value = value;
                this.rejectedCallbacks.forEach(cb => cb());
                // })
                // return this;
            }
        }

        then(
            resolve = function () {
            },
            reject = function () {
            }
        ) {
            if (this.state === "PADDING") {
                this.resolvedCallbacks.push(resolve);
                this.rejectedCallbacks.push(reject);
            }
            if (this.state === "RESOLVED") {
                resolve(this.value);
            }
            if (this.state === "REJECTED") {
                reject(this.value);
            }
        }

        catch(
            reject = function () {
            }
        ) {
            reject(this.value);
        }
    }

    // function Promiseo(fn) {
    //     var state = 'pending';
    //     var doneList = [];
    //     var failList = [];
    //     this.then = function (done, fail) {
    //         switch (state) {
    //             case "pending":
    //                 doneList.push(done);
    //                 //æ¯æ¬¡å¦‚æœæ²¡æœ‰æ¨å…¥failæ–¹æ³•ï¼Œæˆ‘ä¹Ÿä¼šæ¨å…¥ä¸€ä¸ªnullæ¥å ä½
    //                 failList.push(fail || null);
    //                 return this;
    //                 break;
    //             case 'fulfilled':
    //                 done();
    //                 return this;
    //                 break;
    //             case 'rejected':
    //                 fail();
    //                 return this;
    //                 break;
    //         }
    //     }
    //
    //     function resolve(newValue) {
    //         state = "fulfilled";
    //         setTimeout(function () {
    //             var value = newValue;
    //             for (var i = 0; i < doneList.length; i++) {
    //                 var temp = doneList[i](value);
    //                 if (temp instanceof Promise) {
    //                     var newP = temp;
    //                     for (i++; i < doneList.length; i++) {
    //                         newP.then(doneList[i], failList[i]);
    //                     }
    //                 } else {
    //                     value = temp;
    //                 }
    //             }
    //         }, 0);
    //     }
    //
    //     function reject(newValue) {
    //         state = "rejected";
    //         setTimeout(function () {
    //             var value = newValue;
    //             var tempRe = failList[0](value);
    //             //å¦‚æœrejecté‡Œé¢ä¼ å…¥äº†ä¸€ä¸ªpromiseï¼Œé‚£ä¹ˆæ‰§è¡Œå®Œæ­¤æ¬¡çš„failä¹‹åï¼Œå°†å‰©ä½™çš„doneå’Œfailä¼ å…¥æ–°çš„promiseä¸­
    //             if (tempRe instanceof Promise) {
    //                 var newP = tempRe;
    //                 for (i = 1; i < doneList.length; i++) {
    //                     newP.then(doneList[i], failList[i]);
    //                 }
    //             } else {
    //                 //å¦‚æœä¸æ˜¯promiseï¼Œæ‰§è¡Œå®Œå½“å‰çš„failä¹‹åï¼Œç»§ç»­æ‰§è¡ŒdoneList
    //                 value = tempRe;
    //                 doneList.shift();
    //                 failList.shift();
    //                 resolve(value);
    //             }
    //         }, 0);
    //     }
    //
    //     fn(resolve, reject);
    // }

    class Promiseo {
        constructor(executor) {
            this.status = 'pending';
            this.onResolvedCallback = [];
            this.onRejectedCallback = [];
            try {
                executor(resolve, reject);
            } catch (reason) {
                this.reject(reason);
            }
        }

        resolve(value) {
            let self = this;
            if (value instanceof Promiseo) {
                return value.then(self.resolve, self.reject);
            }
            setTimeout(function () { // å¼‚æ­¥æ‰§è¡Œæ‰€æœ‰çš„å›è°ƒå‡½æ•°
                if (self.status === 'pending') {
                    self.status = 'resolved';
                    self.data = value;
                    self.onResolvedCallback.forEach(v => {
                        v(value);
                    })
                }
            })
        }

        reject(reason) {
            let self = this;
            setTimeout(function () { // å¼‚æ­¥æ‰§è¡Œæ‰€æœ‰çš„å›è°ƒå‡½æ•°
                if (self.status === 'pending') {
                    self.status = 'rejected';
                    self.data = reason;
                    self.onRejectedCallback.forEach(v => {
                        v(reason);
                    })
                }
            })
        }

        resolvePromise(promise2, x, resolve, reject) {
            var then;
            var thenCalledOrThrow = false;
            var self = this;
            if (promise2 === x) {
                return reject(new TypeError('Chaining cycle detected for promise!'));
            }

            if (x instanceof Promiseo) {
                if (x.status === 'pending') { //because x could resolved by a Promise Object
                    x.then(function (v) {
                        self.resolvePromise(promise2, v, resolve, reject);
                    }, reject)
                } else { //but if it is resolved, it will never resolved by a Promise Object but a static value;
                    x.then(resolve, reject);
                }
                return;
            }

            if ((x !== null) && ((typeof x === 'object') || (typeof x === 'function'))) {
                try {
                    then = x.then //because x.then could be a getter
                    if (typeof then === 'function') {
                        then.call(x, function rs(y) {
                            if (thenCalledOrThrow) return;
                            thenCalledOrThrow = true;
                            return self.resolvePromise(promise2, y, resolve, reject);
                        }, function rj(r) {
                            if (thenCalledOrThrow) return;
                            thenCalledOrThrow = true;
                            return reject(r);
                        })
                    } else {
                        resolve(x);
                    }
                } catch (e) {
                    if (thenCalledOrThrow) return;
                    thenCalledOrThrow = true;
                    return reject(e);
                }
            } else {
                resolve(x);
            }
        }

        then(onResolved, onRejected) {
            var self = this;
            var promise2;
            onResolved = typeof onResolved === 'function' ? onResolved :
                function (v) {
                    return v;
                }
            onRejected = typeof onRejected === 'function' ? onRejected :
                function (r) {
                    throw r;
                }

            if (self.status === 'resolved') {
                return promise2 = new Promiseo(function (resolve, reject) {
                    setTimeout(function () { // å¼‚æ­¥æ‰§è¡ŒonResolved
                        try {
                            var x = onResolved(self.data);
                            self.resolvePromise(promise2, x, resolve, reject);
                        } catch (reason) {
                            reject(reason);
                        }
                    })
                })
            }

            if (self.status === 'rejected') {
                return promise2 = new Promiseo(function (resolve, reject) {
                    setTimeout(function () { // å¼‚æ­¥æ‰§è¡ŒonRejected
                        try {
                            var x = onRejected(self.data);
                            self.resolvePromise(promise2, x, resolve, reject);
                        } catch (reason) {
                            reject(reason);
                        }
                    })
                })
            }

            if (self.status === 'pending') {
                // è¿™é‡Œä¹‹æ‰€ä»¥æ²¡æœ‰å¼‚æ­¥æ‰§è¡Œï¼Œæ˜¯å› ä¸ºè¿™äº›å‡½æ•°å¿…ç„¶ä¼šè¢«resolveæˆ–rejectè°ƒç”¨ï¼Œ
                // è€Œresolveæˆ–rejectå‡½æ•°é‡Œçš„å†…å®¹å·²æ˜¯å¼‚æ­¥æ‰§è¡Œï¼Œæ„é€ å‡½æ•°é‡Œçš„å®šä¹‰
                return promise2 = new Promiseo(function (resolve, reject) {
                    self.onResolvedCallback.push(function (value) {
                        try {
                            var x = onResolved(value);
                            self.resolvePromise(promise2, x, resolve, reject);
                        } catch (r) {
                            reject(r);
                        }
                    })

                    self.onRejectedCallback.push(function (reason) {
                        try {
                            var x = onRejected(reason);
                            self.resolvePromise(promise2, x, resolve, reject);
                        } catch (r) {
                            reject(r);
                        }
                    })
                })
            }
        }

        catch(onRejected) {
            return this.then(null, onRejected);
        }

        all(arr) {
            return new Promiseo((resolve, reject) => {
                let values = [];
                let len = arr.length;
                for (var i = 0; i < len; i++) {
                    let promise = arr[i];
                    if (typeof promise.then == 'function') {
                        promise.then(res => {
                            values.push(res);
                            if (values.length == len) {
                                resolve(values);
                            }
                        })
                    }
                }
            })
        }

        race(arr) {
            return new Promiseo((resolve, reject) => {
                let len = arr.length;
                for (var i = 0; i < len; i++) {
                    let promise = arr[i];
                    if (typeof promise.then == 'function') {
                        promise.then(res => {
                            resolve(res);
                        })
                    }
                }
            })
        }
    }

    function want() {
        console.log('è¿™æ˜¯ä½ æƒ³è¦æ‰§è¡Œçš„ä»£ç ');
    }

    function fn(want) {
        console.log('è¿™é‡Œè¡¨ç¤ºæ‰§è¡Œäº†ä¸€å¤§å †å„ç§ä»£ç ');

        // è¿”å›Promiseå¯¹è±¡
        return new Promise(function (resolve, reject) {
            if (typeof want == 'function') {
                resolve(want);
            } else {
                reject('TypeError: ' + want + 'ä¸æ˜¯ä¸€ä¸ªå‡½æ•°')
            }
        })
    }

    fn(want).then(function (want) {
        want();
    })

    // fn('1234').then(
    //     function (want) {
    //         want();
    //     },
    //     function (err) {
    //         console.log(err);
    //     }
    // )
    //then(null, function() {}) å°±ç­‰åŒäºcatch(function() {})

    fn('1234').catch(function (err) {
        console.log(err);
    })

    function want1() {
        console.log('è¿™æ˜¯ä½ æƒ³è¦æ‰§è¡Œçš„ä»£ç my');
    }

    function fn2(want) {
        console.log('è¿™é‡Œè¡¨ç¤ºæ‰§è¡Œäº†ä¸€å¤§å †å„ç§ä»£ç my');

        // è¿”å›Promiseå¯¹è±¡
        return new Promiseo(function (resolve, reject) {
            if (typeof want == 'function') {
                resolve(want);
            } else {
                reject('TypeError: ' + want + 'ä¸æ˜¯ä¸€ä¸ªå‡½æ•°my')
            }
        })
    }

    fn2(want1).then(function (want) {
        want();
    })

    fn2('1234').catch(function (err) {
        console.log(err);
    })

</script>
</body>
</html>
