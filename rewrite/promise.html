<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Promise</title>
</head>
<body>
<script>
    class Promise {
        constructor() {
            this.callbacks = []
            this.oncatch = null
        }

        reject(result) {
            this.complete('reject', result)
        }

        resolve(result) {
            this.complete('resolve', result)
        }

        complete(type, result) {
            if (type === 'reject' && this.oncatch) {
                this.callbacks = []
                this.oncatch(result)
            } else if (this.callbacks[0]) {// åˆ¤æ–­ç¬¬ä¸€ä¸ª
                var handlerObj = this.callbacks.shift() // å–å‡ºç¬¬ä¸€ä¸ªï¼Œä¿®æ”¹åŸæ•°ç»„ï¼›
                if (handlerObj[type]) {
                    handlerObj[type](result)
                }
            }
        }

        then(onsuccess, onfail) {
            this.callbacks.push({
                resolve: onsuccess,
                reject: onfail
            })
            return this
        }

        catch(onfail) {
            this.oncatch = onfail
            return this
        }
    }

    var promise = new Promise()

    function fn1() {
        setTimeout(function () {
            var random = Math.random();
            console.log('--log--:', random)
            if (random > 0.5) {
                promise.resolve('æ­å·')
            } else {
                promise.reject('æ­å·')
            }
        })
        return promise
    }

    function success1(city) {
        setTimeout(function () {
            promise.resolve(city + 'æ™´å¤©')
            console.log(city + 'æ™´å¤©')
        }, 1000)
    }

    function error1(city) {
        setTimeout(function () {
            promise.reject(city + 'ä¸‹é›¨ğŸŒ§å¤©')
            console.log(city + 'ä¸‹é›¨ğŸŒ§å¤©')
        }, 1000)
    }

    function success2(weather) {
        setTimeout(function () {
            console.log(weather + 'ï¼Œå¤©æ°”ä¸é”™ï¼Œå¯æºå¥³å‹ä¸ç‹—å‡ºè¡Œ')
        }, 1000)
    }

    function error2(weather) {
        setTimeout(function () {
            console.log(weather + 'ï¼Œæ— æ³•å¸¦ç‹—ç‹—ç©äº†ï¼')
        }, 1000)
    }

    function onerror() {
        console.log('é”™è¯¯âå•¦')
    }

    fn1().then(success1, error1)
        .then(success2, error2)
        .catch(onerror)
</script>
</body>
</html>
